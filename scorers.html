<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Top Scorers</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" type="image/jpeg" href="fifa26.jpeg">

<style>
  body{font-family:'Cairo',Arial,sans-serif;color:#fff;font-weight:700;
    background:linear-gradient(rgba(15,15,15,.85),rgba(15,15,15,.85)),url("standings-bg.jpg");
    background-size:cover;background-position:center;background-attachment:fixed;}
  .page-header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;}
  .header-logo{height:100px;object-fit:contain;}
  nav{display:flex;justify-content:center;gap:20px;margin-bottom:20px;}
  nav a{text-decoration:none;color:#fff;font-weight:700;padding:10px 25px;border-radius:8px;transition:.3s;background:#2b2b2b;}
  nav a:hover{background:#3498db;transform:scale(1.05);}
  nav a.active{background:#3498db;box-shadow:0 4px 8px rgba(0,0,0,.3);}
  h2{text-align:center;margin:10px 0 15px;font-weight:800;}
  table{width:100%;border-collapse:collapse;font-size:14px;}
  th{background:#2b2b2b;padding:10px;font-weight:800;}
  td{padding:8px;text-align:center;}
  tr:nth-child(even){background:#1a1a1a;}
  .wrap{max-width:1100px;margin:0 auto;padding:0 10px 30px;}
  .filters{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:10px 0 18px;}
  select,input{padding:10px 12px;border-radius:8px;border:0;outline:0;font-family:'Cairo',Arial;}
</style>
</head>

<body>

<div class="page-header">
  <img src="left-logo.png" class="header-logo" alt="Left Logo">
  <img src="right-logo.png" class="header-logo" alt="Right Logo">
</div>

<nav>
  <a href="index.html">Standings</a>
  <a href="matches.html">Results</a>
  <a href="upcoming.html">Upcoming</a>
  <a href="team-stats.html">Stats</a>
  <a href="scorers.html" class="active">Scorers</a>
</nav>

<div class="wrap">
  <h2>Top Scorers</h2>

  <div class="filters">
    <input id="search" placeholder="Search player..." />
    <select id="ownerFilter">
      <option value="">All Owners</option>
    </select>
    <select id="weekFilter">
      <option value="">All Weeks</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Player</th>
        <th>Team</th>
        <th>Owner</th>
        <th>Goals</th>
        <th>Avg Minute</th>
      </tr>
    </thead>
    <tbody id="scorersBody"></tbody>
  </table>
</div>

<script>
const scorersURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT54W8eLRnu7YjOYR49uv-FWsBL1VZR3JUptdsdaP7gYmVIyrtHEmoOd0ZR0uaAijzMXbAhmweN1_5n/pub?gid=940156222&single=true&output=csv"; // <-- حط رابط CSV بتاع شيت الهدافين

function parseCSV(text) {
  return text.trim().split("\n").map(row =>
    row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(col => col.replace(/^"|"$/g, '').trim())
  );
}

// يحوّل Time إلى "دقائق" (يدعم 23 أو 23:15)
function toMinute(timeStr){
  if(!timeStr) return null;
  const t = String(timeStr).trim();
  if(/^\d+$/.test(t)) return Number(t);
  const m = t.match(/^(\d+)\s*:\s*(\d+)$/);
  if(m) return Number(m[1]) + (Number(m[2]) / 60);
  return null;
}

let raw = [];        // كل الأهداف
let aggregated = []; // بعد التجميع

function buildFilters(){
  const ownerSet = new Set();
  const weekSet = new Set();

  raw.forEach(r=>{
    if(r.owner) ownerSet.add(r.owner);
    if(r.week) weekSet.add(r.week);
  });

  const ownerFilter = document.getElementById("ownerFilter");
  const weekFilter  = document.getElementById("weekFilter");

  [...ownerSet].sort().forEach(o=>{
    const opt=document.createElement("option");
    opt.value=o; opt.textContent=o;
    ownerFilter.appendChild(opt);
  });

  [...weekSet].sort((a,b)=>Number(a)-Number(b)).forEach(w=>{
    const opt=document.createElement("option");
    opt.value=w; opt.textContent="Week " + w;
    weekFilter.appendChild(opt);
  });
}

function aggregateData(){
  // نجمع حسب: Player + Team + Owner
  const map = new Map();

  raw.forEach(g=>{
    const key = `${g.player}||${g.team}||${g.owner}`;
    if(!map.has(key)){
      map.set(key, { player:g.player, team:g.team, owner:g.owner, goals:0, minuteSum:0, minuteCount:0 });
    }
    const item = map.get(key);
    item.goals += 1;

    const m = toMinute(g.time);
    if(m !== null){
      item.minuteSum += m;
      item.minuteCount += 1;
    }
  });

  aggregated = [...map.values()].map(x=>({
    ...x,
    avgMinute: x.minuteCount ? (x.minuteSum / x.minuteCount) : null
  }));

  // ترتيب: أهداف نزولاً ثم اسم اللاعب
  aggregated.sort((a,b)=> (b.goals - a.goals) || a.player.localeCompare(b.player));
}

function render(){
  const tbody = document.getElementById("scorersBody");
  const q = document.getElementById("search").value.trim().toLowerCase();
  const owner = document.getElementById("ownerFilter").value;
  const week  = document.getElementById("weekFilter").value;

  // فلترة الـ raw الأول (عشان week يشتغل)
  let filteredRaw = raw.slice();
  if(owner) filteredRaw = filteredRaw.filter(x => x.owner === owner);
  if(week)  filteredRaw = filteredRaw.filter(x => String(x.week) === String(week));
  if(q)     filteredRaw = filteredRaw.filter(x => x.player.toLowerCase().includes(q));

  // اعمل aggregation للجزء المفلتر
  const map = new Map();
  filteredRaw.forEach(g=>{
    const key = `${g.player}||${g.team}||${g.owner}`;
    if(!map.has(key)){
      map.set(key, { player:g.player, team:g.team, owner:g.owner, goals:0, minuteSum:0, minuteCount:0 });
    }
    const item = map.get(key);
    item.goals++;
    const m = toMinute(g.time);
    if(m !== null){ item.minuteSum += m; item.minuteCount++; }
  });

  const view = [...map.values()].map(x=>({
    ...x,
    avgMinute: x.minuteCount ? (x.minuteSum / x.minuteCount) : null
  })).sort((a,b)=> (b.goals - a.goals) || a.player.localeCompare(b.player));

  tbody.innerHTML = "";
  view.forEach((row, i)=>{
    const avg = row.avgMinute === null ? "-" : row.avgMinute.toFixed(1);
    tbody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${row.player}</td>
        <td>${row.team}</td>
        <td>${row.owner}</td>
        <td>${row.goals}</td>
        <td>${avg}</td>
      </tr>`;
  });
}

fetch(scorersURL + "&t=" + Date.now(), { cache:"no-store" })
.then(res => res.text())
.then(csv=>{
  const data = parseCSV(csv);
  const rows = data.slice(1); // تجاهل الهيدر

  raw = rows
    .map(r=>({
      week: r[0],
      matchId: r[1],
      team: r[2],
      player: r[3],
      time: r[4],
      owner: r[5]
    }))
    .filter(x => x.player && x.team); // تجاهل السطور الفاضية

  buildFilters();
  aggregateData();
  render();

  document.getElementById("search").addEventListener("input", render);
  document.getElementById("ownerFilter").addEventListener("change", render);
  document.getElementById("weekFilter").addEventListener("change", render);
})
.catch(err => console.error("Error loading scorers sheet:", err));
</script>

</body>
</html>
