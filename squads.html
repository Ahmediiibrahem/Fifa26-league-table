<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Squads</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" type="image/jpeg" href="fifa26.jpeg">

<style>
body{
  margin:0;
  font-family:'Cairo',Arial,sans-serif;
  color:#fff;
  font-weight:700;
  background:linear-gradient(rgba(15,15,15,.85),rgba(15,15,15,.85)),url("standings-bg.jpg");
  background-size:cover;
  background-attachment:fixed;
}

/* Header / Nav */
.page-header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;}
.header-logo{height:100px;object-fit:contain;}
nav{display:flex;justify-content:center;gap:20px;margin-bottom:20px;flex-wrap:wrap;padding:0 10px;}
nav a{color:#fff;text-decoration:none;background:#2b2b2b;padding:10px 25px;border-radius:8px;font-weight:800;transition:.2s}
nav a.active,nav a:hover{background:#3498db;}

/* Layout */
.wrap{max-width:1200px;margin:auto;padding:0 10px 30px}
h2{text-align:center;margin:10px 0 14px;font-weight:900}

/* TEAM TABS: 2 rows (8 columns) */
.club-tabs{
  display:grid;
  grid-template-columns:repeat(8, 1fr);
  gap:10px;
  margin:12px 0;
}
@media(max-width:900px){ .club-tabs{grid-template-columns:repeat(4,1fr)} }
@media(max-width:520px){ .club-tabs{grid-template-columns:repeat(2,1fr)} }

.tab{
  background:#2b2b2b;
  border-radius:12px;
  padding:10px;
  text-align:center;
  cursor:pointer;
  transition:.2s;
  border:1px solid rgba(255,255,255,.10);
  user-select:none;
}
.tab:hover{background:#3498db}
.tab.active{background:#3498db;box-shadow:0 6px 14px rgba(0,0,0,.35);border-color:rgba(52,152,219,.6)}

.tab img{width:28px;height:28px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.6))}
.tab.all-teams{
  display:flex;align-items:center;justify-content:center;
  font-weight:900;
  gap:8px;
}

/* Divider */
.divider{height:1px;background:rgba(255,255,255,.15);margin:12px 0}

/* Row Tabs */
.tabs-row{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}

/* Search */
.search-box{
  display:flex;align-items:center;gap:10px;
  background:rgba(0,0,0,.4);
  border-radius:14px;
  padding:10px 14px;
  max-width:700px;
  margin:0 auto 14px;
  border:1px solid rgba(255,255,255,.10);
}
.search-box input{
  width:100%;
  background:none;border:0;outline:0;
  color:#fff;font-weight:900;
  font-family:'Cairo',Arial;
  font-size:14px;
}

/* Summary */
.summary{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin:14px 0;
}
@media(max-width:900px){.summary{grid-template-columns:repeat(2,1fr)}}
.card{
  background:rgba(0,0,0,.4);
  border-radius:14px;
  padding:12px;
  border:1px solid rgba(255,255,255,.10);
}
.card .k{font-size:12px;opacity:.8;font-weight:700}
.card .v{font-size:18px;font-weight:900;margin-top:4px;word-break:break-word}

/* Table */
.table-wrap{overflow:auto;border-radius:12px}
table{width:100%;border-collapse:collapse;font-size:14px}
th{background:#2b2b2b;padding:10px;font-weight:900;white-space:nowrap}
td{padding:8px;text-align:center;white-space:nowrap}
tr:nth-child(even){background:#1a1a1a}

.player-cell{display:flex;align-items:center;gap:10px;text-align:left;min-width:260px}
.player-cell img{width:22px;height:22px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.6))}
.muted{font-size:12px;opacity:.8}
.pill{padding:4px 10px;border-radius:999px;background:rgba(52,152,219,.25);font-size:12px;font-weight:900}
.empty{text-align:center;margin-top:14px;opacity:.85}
</style>
</head>

<body>

<div class="page-header">
  <img src="left-logo.png" class="header-logo" alt="">
  <img src="right-logo.png" class="header-logo" alt="">
</div>

<nav>
  <a href="index.html">Standings</a>
  <a href="matches.html">Results</a>
  <a href="upcoming.html">Upcoming</a>
  <a href="team-stats.html">Stats</a>
  <a href="scorers.html">Scorers</a>
  <a href="squads.html" class="active">Squads</a>
</nav>

<div class="wrap">
  <h2>Squads</h2>

  <!-- Clubs -->
  <div id="clubTabs" class="club-tabs"></div>

  <div class="divider"></div>

  <!-- Position -->
  <div id="posTabs" class="tabs-row"></div>

  <div class="divider"></div>

  <!-- Sort -->
  <div id="sortTabs" class="tabs-row"></div>

  <div class="divider"></div>

  <!-- Search (no browser suggestions) -->
  <div class="search-box">
    üîç
    <input id="search" name="searchbox_no_suggest_123" autocomplete="off"
           autocapitalize="off" autocorrect="off" spellcheck="false"
           placeholder="Search: name, age, shirt, goals, value, club..." />
  </div>

  <div class="summary">
    <div class="card"><div class="k">Players</div><div class="v" id="sumPlayers">-</div></div>
    <div class="card"><div class="k">Average Age</div><div class="v" id="sumAvgAge">-</div></div>
    <div class="card"><div class="k">Total Market Value</div><div class="v" id="sumTotalValue">-</div></div>
    <div class="card"><div class="k">Top Value Player</div><div class="v" id="sumMVP">-</div></div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Player</th>
          <th>Pos</th>
          <th>PosSC</th>
          <th>Age</th>
          <th>Nat</th>
          <th>Foot</th>
          <th>Market</th>
          <th>Goals</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div id="empty" class="empty" style="display:none;">No players found.</div>
</div>

<script>
const squadsURL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT54W8eLRnu7YjOYR49uv-FWsBL1VZR3JUptdsdaP7gYmVIyrtHEmoOd0ZR0uaAijzMXbAhmweN1_5n/pub?gid=609829485&single=true&output=csv";
const scorersURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT54W8eLRnu7YjOYR49uv-FWsBL1VZR3JUptdsdaP7gYmVIyrtHEmoOd0ZR0uaAijzMXbAhmweN1_5n/pub?gid=940156222&single=true&output=csv";

function parseCSV(t){
  return t.trim().split("\n").map(r =>
    r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g,"").trim())
  );
}
const logoSrc = (t)=> `logos/${encodeURIComponent(t)}.png`;

function parseMarketValue(cell){
  if(cell == null) return 0;
  const s = String(cell).toLowerCase().replace(/,/g,"").trim();
  const m = s.match(/(\d+(\.\d+)?)/);
  return m ? Number(m[1]) : 0;
}
function fmtM(v){
  const n = Math.round((Number(v||0))*10)/10;
  return String(n);
}

/* ‚úÖ normalize PositionSC to exact: GK / Def / Mid / Att */
function normPosSC(x){
  const s = String(x||"").trim().toLowerCase();
  if(!s) return "";
  if(s === "gk" || s.includes("goal")) return "GK";
  if(s === "def" || s === "df" || s.includes("back")) return "Def";
  if(s === "mid" || s === "mf" || s.includes("mid")) return "Mid";
  if(s === "att" || s === "fw" || s.includes("for") || s.includes("attack")) return "Att";
  // fallback: capitalize first
  return s.charAt(0).toUpperCase() + s.slice(1);
}

/* State */
let all = [];
let clubs = [];
let goalsMap = {}; // key: team||player => goals

let activeClub = "ALL";
let activePos  = "All";
let activeSort = "all"; // all/shirt/age/value/name/goals

/* Tabs builders (build once) */
function buildTabs(){
  // Club tabs
  const ct = document.getElementById("clubTabs");
  ct.innerHTML = "";

  const allTeamsTab = document.createElement("div");
  allTeamsTab.className = "tab all-teams active";
  allTeamsTab.id = "tab_club_ALL";
  allTeamsTab.innerHTML = "üåç <span>All Teams</span>";
  allTeamsTab.onclick = ()=> setClub("ALL");
  ct.appendChild(allTeamsTab);

  clubs.forEach(c=>{
    const tab = document.createElement("div");
    tab.className = "tab";
    tab.id = "tab_club_" + cssSafeId(c);

    const img = document.createElement("img");
    img.src = logoSrc(c);
    img.alt = c;
    img.onerror = function(){ this.style.display="none"; };

    tab.appendChild(img);
    tab.onclick = ()=> setClub(c);
    ct.appendChild(tab);
  });

  // Position tabs
  const pt = document.getElementById("posTabs");
  pt.innerHTML = "";
  ["All","GK","Def","Mid","Att"].forEach(p=>{
    const tab = document.createElement("div");
    tab.className = "tab" + (p===activePos ? " active":"");
    tab.id = "tab_pos_" + p;
    tab.textContent = p;
    tab.onclick = ()=> setPos(p);
    pt.appendChild(tab);
  });

  // Sort tabs (‚úÖ includes All + Goals)
  const st = document.getElementById("sortTabs");
  st.innerHTML = "";

  const sorts = [
    {k:"all",   label:"All"},
    {k:"shirt", label:"Shirt #"},
    {k:"age",   label:"Age"},
    {k:"value", label:"Value"},
    {k:"name",  label:"Name"},
    {k:"goals", label:"Goals"}
  ];

  sorts.forEach(s=>{
    const tab = document.createElement("div");
    tab.className = "tab" + (s.k===activeSort ? " active":"");
    tab.id = "tab_sort_" + s.k;
    tab.textContent = s.label;
    tab.onclick = ()=> setSort(s.k);
    st.appendChild(tab);
  });
}

function cssSafeId(s){
  return btoa(unescape(encodeURIComponent(String(s)))).replace(/=+/g,"");
}

function setActiveTab(prefix, id){
  document.querySelectorAll(`[id^="${prefix}"]`).forEach(el=> el.classList.remove("active"));
  const target = document.getElementById(prefix + id);
  if(target) target.classList.add("active");
}

function setClub(c){
  activeClub = c;
  setActiveTab("tab_club_", c==="ALL" ? "ALL" : cssSafeId(c));
  render();
}
function setPos(p){
  activePos = p;
  setActiveTab("tab_pos_", p);
  render();
}
function setSort(k){
  activeSort = k;
  setActiveTab("tab_sort_", k);
  render();
}

/* Render */
function render(){
  const q = document.getElementById("search").value.trim().toLowerCase();
  let rows = all;

  if(activeClub !== "ALL") rows = rows.filter(r=> r.club === activeClub);
  if(activePos !== "All")  rows = rows.filter(r=> r.posSC === activePos);

  if(q){
    rows = rows.filter(r=>{
      const blob = [
        r.player, r.club, r.pos, r.posSC,
        r.age, r.shirt, r.nat, r.foot,
        r.value, r.goals
      ].join(" ").toLowerCase();
      return blob.includes(q);
    });
  }

  // Sort
  rows = rows.slice(); // copy
  if(activeSort === "all" || activeSort === "shirt"){
    rows.sort((a,b)=> (a.shirt - b.shirt) || a.player.localeCompare(b.player));
  } else if(activeSort === "age"){
    rows.sort((a,b)=> ((a.age ?? 999) - (b.age ?? 999)) || a.player.localeCompare(b.player));
  } else if(activeSort === "value"){
    rows.sort((a,b)=> (b.value - a.value) || a.player.localeCompare(b.player));
  } else if(activeSort === "name"){
    rows.sort((a,b)=> a.player.localeCompare(b.player));
  } else if(activeSort === "goals"){
    rows.sort((a,b)=> (b.goals - a.goals) || (b.value - a.value) || a.player.localeCompare(b.player));
  }

  // Summary (‚úÖ ÿ®ÿØŸàŸÜ ÿ£Ÿä sort ÿ•ÿ∂ÿßŸÅŸä)
  const playersCount = rows.length;
  const ages = rows.map(r=>r.age).filter(a=>Number.isFinite(a));
  const avgAge = ages.length ? (ages.reduce((s,x)=>s+x,0)/ages.length) : null;
  const totalValue = rows.reduce((s,r)=> s + (r.value||0), 0);

  let mvpName = "-";
  let maxV = -1;
  rows.forEach(r=>{
    if((r.value||0) > maxV){ maxV = r.value||0; mvpName = r.player; }
  });

  document.getElementById("sumPlayers").textContent = playersCount ? playersCount : "-";
  document.getElementById("sumAvgAge").textContent  = avgAge ? (Math.round(avgAge*10)/10) : "-";
  document.getElementById("sumTotalValue").textContent = playersCount ? `${fmtM(totalValue)} M` : "-";
  document.getElementById("sumMVP").textContent = playersCount ? `${mvpName} (${fmtM(maxV)} M)` : "-";

  // Table
  const tb = document.getElementById("tbody");
  const empty = document.getElementById("empty");
  tb.innerHTML = "";

  if(rows.length === 0){
    empty.style.display="block";
    return;
  }
  empty.style.display="none";

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.shirt || ""}</td>
      <td>
        <div class="player-cell">
          <img src="${logoSrc(r.club)}" alt="${r.club}" onerror="this.style.display='none'">
          <div>
            <div style="font-weight:900">${r.player}</div>
            <div class="muted">${r.club}</div>
          </div>
        </div>
      </td>
      <td>${r.pos || ""}</td>
      <td>${r.posSC || ""}</td>
      <td>${Number.isFinite(r.age) ? r.age : "-"}</td>
      <td>${r.nat || ""}</td>
      <td>${r.foot ? `<span class="pill">${r.foot}</span>` : ""}</td>
      <td>${fmtM(r.value)}</td>
      <td>${r.goals || 0}</td>
    `;
    tb.appendChild(tr);
  });
}

/* Load */
Promise.all([
  fetch(squadsURL + "&t=" + Date.now(), {cache:"no-store"}).then(r=>r.text()),
  fetch(scorersURL + "&t=" + Date.now(), {cache:"no-store"}).then(r=>r.text())
]).then(([sCSV,gCSV])=>{

  // Goals map: TeamName (col2) + Player Name (col3)
  const gRows = parseCSV(gCSV).slice(1);
  goalsMap = {};
  gRows.forEach(r=>{
    const team = (r[2]||"").trim();
    const player = (r[3]||"").trim();
    if(!team || !player) return;
    const key = (team + "||" + player).toLowerCase();
    goalsMap[key] = (goalsMap[key] || 0) + 1;
  });

  // Squads
  const rows = parseCSV(sCSV).slice(1);
  all = rows.map(r=>{
    const club   = (r[0]||"").trim();
    const player = (r[2]||"").trim();
    const shirt  = Number(r[1]) || 0;
    const pos    = (r[3]||"").trim();
    const age    = Number(r[5]) || null;
    const nat    = (r[6]||"").trim();
    const foot   = (r[8]||"").trim().toUpperCase();
    const value  = parseMarketValue(r[12]);
    const posSC  = normPosSC(r[13]); // ‚úÖ FIX

    const gKey = (club + "||" + player).toLowerCase();
    const goals = goalsMap[gKey] || 0;

    return { club, player, shirt, pos, age, nat, foot, value, posSC, goals };
  }).filter(x=> x.club && x.player);

  clubs = [...new Set(all.map(x=>x.club))].sort();

  buildTabs();          // build once
  setClub("ALL");       // default active
  setPos("All");        // default
  setSort("all");       // default
  render();

}).catch(err => console.error("Load error:", err));

document.getElementById("search").addEventListener("input", render);
</script>

</body>
</html>
