<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Squads</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" type="image/jpeg" href="fifa26.jpeg">

<style>
  body{
    margin:0;
    font-family:'Cairo',Arial,sans-serif;
    color:#fff;
    font-weight:700;
    background:linear-gradient(rgba(15,15,15,.85),rgba(15,15,15,.85)),url("standings-bg.jpg");
    background-size:cover;
    background-position:center;
    background-attachment:fixed;
  }

  .page-header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;}
  .header-logo{height:100px;object-fit:contain;}

  nav{display:flex;justify-content:center;gap:20px;margin-bottom:20px;flex-wrap:wrap;padding:0 10px;}
  nav a{
    text-decoration:none;color:#fff;font-weight:700;padding:10px 25px;border-radius:8px;
    transition:.3s;background:#2b2b2b;
  }
  nav a:hover{background:#3498db;transform:scale(1.05);}
  nav a.active{background:#3498db;box-shadow:0 4px 8px rgba(0,0,0,.3);}

  .wrap{max-width:1150px;margin:0 auto;padding:0 10px 30px;}
  h2{text-align:center;margin:10px 0 14px;font-weight:800;}

  /* ===== Tabs ===== */
  .tabs-grid{
    display:grid;
    grid-template-columns:repeat(8, 1fr);
    gap:10px;
    margin:12px 0;
  }
  @media (max-width: 1000px){
    .tabs-grid{grid-template-columns:repeat(4,1fr);}
  }
  @media (max-width: 520px){
    .tabs-grid{grid-template-columns:repeat(2,1fr);}
  }

  .tabs-row{
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
    margin:12px 0;
  }

  .tab{
    background:#2b2b2b;
    border:1px solid rgba(255,255,255,.10);
    color:#fff;
    border-radius:12px;
    padding:10px 10px;
    text-align:center;
    cursor:pointer;
    transition:.2s;
    font-weight:900;
    user-select:none;
  }
  .tab:hover{background:#3498db;}
  .tab.active{
    background:#3498db;
    box-shadow:0 6px 16px rgba(0,0,0,.35);
    border-color:rgba(52,152,219,.65);
  }

  .divider{
    height:1px;
    width:100%;
    background:rgba(255,255,255,.12);
    margin:10px 0;
  }

  .search-wrap{
    display:flex;
    justify-content:center;
    margin:10px 0 14px;
  }
  .search-box{
    width:min(720px, 100%);
    display:flex;
    align-items:center;
    gap:10px;
    background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    padding:10px 12px;
  }
  .search-box input{
    width:100%;
    border:0;
    outline:0;
    background:transparent;
    color:#fff;
    font-family:'Cairo',Arial;
    font-weight:800;
    font-size:14px;
  }
  .search-hint{
    font-size:12px;
    opacity:.8;
    font-weight:700;
    margin-top:6px;
    text-align:center;
  }

  /* ===== Summary ===== */
  .summary{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:10px;
    margin:14px 0 16px;
  }
  @media (max-width: 900px){
    .summary{grid-template-columns:repeat(2,1fr);}
  }
  .card{
    background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    padding:12px 12px;
  }
  .card .k{font-size:12px;opacity:.85;font-weight:700;}
  .card .v{font-size:18px;font-weight:900;margin-top:4px;word-break:break-word;}

  /* ===== Table ===== */
  table{width:100%;border-collapse:collapse;font-size:14px;}
  th{background:#2b2b2b;padding:10px;font-weight:900;text-align:center;white-space:nowrap;}
  td{padding:10px 8px;text-align:center;white-space:nowrap;}
  tr:nth-child(even){background:#1a1a1a;}

  .table-wrap{width:100%;overflow:auto;border-radius:12px;}

  .player-cell{
    display:flex;
    align-items:center;
    justify-content:flex-start;
    gap:10px;
    text-align:left;
    min-width:260px;
  }
  .mini-logo{
    width:22px;height:22px;object-fit:contain;
    filter:drop-shadow(0 2px 6px rgba(0,0,0,.6));
    flex:0 0 auto;
  }
  .player-name{
    font-weight:900;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .muted{
    opacity:.85;
    font-weight:700;
    font-size:12px;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:900;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(52,152,219,.18);
  }

  .empty{
    text-align:center;
    margin-top:14px;
    opacity:.85;
  }
</style>
</head>

<body>

<div class="page-header">
  <img src="left-logo.png" alt="Left Logo" class="header-logo">
  <img src="right-logo.png" alt="Right Logo" class="header-logo">
</div>

<nav>
  <a href="index.html">Standings</a>
  <a href="matches.html">Results</a>
  <a href="upcoming.html">Upcoming</a>
  <a href="team-stats.html">Stats</a>
  <a href="scorers.html">Scorers</a>
  <a href="squads.html" class="active">Squads</a>
</nav>

<div class="wrap">
  <h2>Squads</h2>

  <!-- Clubs tabs (16 teams -> 2 rows of 8) -->
  <div id="clubTabs" class="tabs-grid"></div>

  <div class="divider"></div>

  <!-- Position tabs -->
  <div id="posTabs" class="tabs-row"></div>

  <div class="divider"></div>

  <!-- Sort tabs -->
  <div id="sortTabs" class="tabs-row"></div>

  <div class="divider"></div>

  <!-- Search -->
  <div class="search-wrap">
    <div class="search-box">
      <span style="opacity:.9;font-weight:900;">ðŸ”Ž</span>
      <input id="search" placeholder="Search anything... (Player / Age / Club / Nat / Position)" />
    </div>
  </div>
  <div class="search-hint">You can search by player name, age, club name, nationality, etc.</div>

  <!-- Summary -->
  <div class="summary">
    <div class="card"><div class="k">Players</div><div class="v" id="sumPlayers">-</div></div>
    <div class="card"><div class="k">Average Age</div><div class="v" id="sumAvgAge">-</div></div>
    <div class="card"><div class="k">Total Market Value</div><div class="v" id="sumTotalValue">-</div></div>
    <div class="card"><div class="k">Most Valuable Player</div><div class="v" id="sumMVP">-</div></div>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Player</th>
          <th>Pos</th>
          <th>Age</th>
          <th>Nat.</th>
          <th>Height</th>
          <th>Foot</th>
          <th>Market (M)</th>
          <th>Goals</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div id="empty" class="empty" style="display:none;">No players found.</div>
</div>

<script>
/* =========================
   CSV SOURCES
========================= */
const squadsURL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT54W8eLRnu7YjOYR49uv-FWsBL1VZR3JUptdsdaP7gYmVIyrtHEmoOd0ZR0uaAijzMXbAhmweN1_5n/pub?gid=609829485&single=true&output=csv";
const scorersURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT54W8eLRnu7YjOYR49uv-FWsBL1VZR3JUptdsdaP7gYmVIyrtHEmoOd0ZR0uaAijzMXbAhmweN1_5n/pub?gid=940156222&single=true&output=csv";

/* =========================
   Helpers
========================= */
function parseCSV(text){
  return text.trim().split("\n").map(row =>
    row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(col => col.replace(/^"|"$/g, "").trim())
  );
}
function teamLogoSrc(clubName){
  return `logos/${encodeURIComponent(clubName)}.png`;
}
function parseMarketValue(cell){
  if(cell == null) return 0;
  const s = String(cell).toLowerCase().replace(/,/g,"").trim();
  const m = s.match(/(\d+(\.\d+)?)/);
  return m ? Number(m[1]) : 0;
}
function fmtM(v){
  const n = Math.round((v || 0) * 10) / 10;
  return String(n);
}
function safeLower(x){ return String(x ?? "").toLowerCase(); }

/* =========================
   State
========================= */
let all = [];                 // all squad players
let clubs = [];               // unique clubs
let goalsByTeamPlayer = {};   // key: team||player => goals

let activeClub = "";          // current club tab
let activePos  = "All";       // All/GK/Def/Mid/Att (PositionSC)
let activeSort = "shirt";     // shirt/age/value/name

/* =========================
   UI Builders
========================= */
function makeTab(text, isActive, onClick){
  const d = document.createElement("div");
  d.className = "tab" + (isActive ? " active" : "");
  d.textContent = text;
  d.addEventListener("click", onClick);
  return d;
}

function buildClubTabs(){
  const wrap = document.getElementById("clubTabs");
  wrap.innerHTML = "";

  // ensures 16 shown, two rows of 8 automatically by grid
  clubs.forEach(club=>{
    wrap.appendChild(
      makeTab(club, club === activeClub, ()=>{
        activeClub = club;
        render();
        buildClubTabs();
      })
    );
  });
}

function buildPosTabs(){
  const wrap = document.getElementById("posTabs");
  wrap.innerHTML = "";

  const items = ["All", "GK", "Def", "Mid", "Att"];
  items.forEach(p=>{
    wrap.appendChild(
      makeTab(p, p === activePos, ()=>{
        activePos = p;
        render();
        buildPosTabs();
      })
    );
  });
}

function buildSortTabs(){
  const wrap = document.getElementById("sortTabs");
  wrap.innerHTML = "";

  const items = [
    {k:"shirt", label:"Shirt #"},
    {k:"age",   label:"Age"},
    {k:"value", label:"Market Value"},
    {k:"name",  label:"Name"}
  ];

  items.forEach(it=>{
    wrap.appendChild(
      makeTab(it.label, it.k === activeSort, ()=>{
        activeSort = it.k;
        render();
        buildSortTabs();
      })
    );
  });
}

/* =========================
   Summary
========================= */
function computeSummary(rows){
  const playersCount = rows.length;
  const ages = rows.map(r=>r.age).filter(a=>Number.isFinite(a));
  const avgAge = ages.length ? (ages.reduce((a,b)=>a+b,0) / ages.length) : null;
  const totalValue = rows.reduce((sum,r)=> sum + (r.value || 0), 0);

  let mvp = null;
  rows.forEach(r=>{
    if(!mvp || (r.value||0) > (mvp.value||0)) mvp = r;
  });

  document.getElementById("sumPlayers").textContent = playersCount ? playersCount : "-";
  document.getElementById("sumAvgAge").textContent = avgAge ? (Math.round(avgAge*10)/10) : "-";
  document.getElementById("sumTotalValue").textContent = playersCount ? `${fmtM(totalValue)} M` : "-";
  document.getElementById("sumMVP").textContent = mvp ? `${mvp.player} (${fmtM(mvp.value)} M)` : "-";
}

/* =========================
   Filtering + Sorting + Search
========================= */
function posMatches(player){
  // activePos uses PositionSC (index 13) - expected values: GK / Def / Mid / Att
  if(activePos === "All") return true;
  return (player.posSC || "").toLowerCase() === activePos.toLowerCase();
}

function applySort(rows){
  const sorted = rows.slice();

  if(activeSort === "shirt"){
    sorted.sort((a,b)=> (a.shirt - b.shirt) || a.player.localeCompare(b.player));
  } else if(activeSort === "age"){
    sorted.sort((a,b)=> ((a.age ?? 999) - (b.age ?? 999)) || a.player.localeCompare(b.player));
  } else if(activeSort === "value"){
    sorted.sort((a,b)=> (b.value - a.value) || a.player.localeCompare(b.player));
  } else if(activeSort === "name"){
    sorted.sort((a,b)=> a.player.localeCompare(b.player));
  }
  return sorted;
}

function render(){
  const tbody = document.getElementById("tbody");
  const empty = document.getElementById("empty");
  const q = document.getElementById("search").value.trim().toLowerCase();

  let rows = all.slice();

  // club tab
  if(activeClub) rows = rows.filter(r => r.club === activeClub);

  // position tabs
  rows = rows.filter(posMatches);

  // search anything
  if(q){
    rows = rows.filter(r=>{
      const blob = [
        r.club,
        r.player,
        r.pos,
        r.posSC,
        r.age,
        r.nat,
        r.height,
        r.foot,
        r.value,
        r.goals
      ].join(" ").toLowerCase();
      return blob.includes(q);
    });
  }

  // sort
  rows = applySort(rows);

  computeSummary(rows);

  tbody.innerHTML = "";
  if(rows.length === 0){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.shirt || ""}</td>
      <td>
        <div class="player-cell">
          <img class="mini-logo" src="${teamLogoSrc(r.club)}" alt="${r.club}" onerror="this.style.display='none'">
          <div style="min-width:0">
            <div class="player-name">${r.player}</div>
            <div class="muted">${r.club}</div>
          </div>
        </div>
      </td>
      <td>${r.pos || ""}</td>
      <td>${Number.isFinite(r.age) ? r.age : "-"}</td>
      <td>${r.nat || ""}</td>
      <td>${r.height || ""}</td>
      <td>${r.foot ? `<span class="pill">${r.foot}</span>` : ""}</td>
      <td>${fmtM(r.value)}</td>
      <td>${r.goals || 0}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================
   Load Data
========================= */
function buildGoalsMap(scorersCSV){
  // Columns: Weeks | MatchID | TeamName | Player Name | Time | Owner
  const rows = parseCSV(scorersCSV).slice(1);
  goalsByTeamPlayer = {};

  rows.forEach(r=>{
    const team = (r[2] || "").trim();
    const player = (r[3] || "").trim();
    if(!team || !player) return;

    const key = `${team}||${player}`.toLowerCase();
    goalsByTeamPlayer[key] = (goalsByTeamPlayer[key] || 0) + 1;
  });
}

Promise.all([
  fetch(squadsURL  + "&t=" + Date.now(), { cache:"no-store" }).then(r=>r.text()),
  fetch(scorersURL + "&t=" + Date.now(), { cache:"no-store" }).then(r=>r.text())
]).then(([squadsCSV, scorersCSV])=>{

  buildGoalsMap(scorersCSV);

  const data = parseCSV(squadsCSV);
  const rows = data.slice(1);

  all = rows.map(r=>{
    // Your squad columns (0-based):
    // 0 Club
    // 1 #
    // 2 Player
    // 3 Position
    // 4 Date of birth/Age
    // 5 Years (AGE)
    // 6 Nat.
    // 7 Height
    // 8 Foot
    // 12 Market value( M)
    // 13 PositionSC (NEW)
    const club   = (r[0] || "").trim();
    const shirt  = Number(r[1]) || 0;
    const player = (r[2] || "").trim();
    const pos    = (r[3] || "").trim();
    const age    = Number(r[5]) || null;
    const nat    = (r[6] || "").trim();
    const height = (r[7] || "").trim();
    const foot   = (r[8] || "").trim().toUpperCase();
    const value  = parseMarketValue(r[12]);
    const posSC  = (r[13] || "").trim(); // GK/Def/Mid/Att

    const gKey = `${club}||${player}`.toLowerCase();
    const goals = goalsByTeamPlayer[gKey] || 0;

    return { club, shirt, player, pos, age, nat, height, foot, value, posSC, goals };
  }).filter(x => x.club && x.player);

  clubs = [...new Set(all.map(x => x.club))].sort();

  // default active club: first one
  activeClub = clubs[0] || "";

  buildClubTabs();
  buildPosTabs();
  buildSortTabs();

  render();

  document.getElementById("search").addEventListener("input", render);

}).catch(err => console.error("Error loading squads/scorers:", err));
</script>

</body>
</html>
